name: Build, Test & Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:

  # ---------------------------------------------------------
  #  WINDOWS BUILD + TEST
  # ---------------------------------------------------------
  build-windows:
    runs-on: windows-latest
    outputs:
      exe_path: ${{ steps.upload.outputs.artifact }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install UPX
        run: |
          curl -LO https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip
          tar -xf upx-4.2.4-win64.zip
          move upx-4.2.4-win64 upx

      - name: Build Windows EXE
        run: |
          pyinstaller --windowed --onefile `
            --icon=icon.ico `
            --upx-dir upx `
            --name "IDMT-Trip-Calculator" idmt_tool/gui/main.py

      - name: Test Windows EXE launches
        run: |
          $p = Start-Process dist\IDMT-Trip-Calculator.exe -PassThru
          Start-Sleep -Seconds 3
          if ($p.HasExited) { Write-Error 'EXE crashed'; exit 1 }
          Stop-Process -Id $p.Id

      - name: Upload Windows EXE
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/IDMT-Trip-Calculator.exe


  # ---------------------------------------------------------
  #  LINUX BUILD + TEST
  # ---------------------------------------------------------
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      appimage: ${{ steps.upload.outputs.appimage }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y libfuse2 fakeroot rpm xvfb

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Build PyInstaller binary
        run: |
          pyinstaller --windowed --onefile \
            --icon icon.png \
            --hidden-import=PIL.Image \
            --hidden-import=PIL.ImageTk \
            --hidden-import=PIL._tkinter_finder \
            --hidden-import=PIL._plugins \
            --name "IDMT-Trip-Calculator" idmt_tool/gui/main.py

      - name: Test standalone binary (headless)
        run: |
          xvfb-run -a dist/IDMT-Trip-Calculator &
          sleep 3
          pgrep -f IDMT-Trip-Calculator || exit 1
          pkill IDMT-Trip-Calculator

      # --- Build AppImage ---
      - name: Download appimagetool
        run: |
          wget -qO appimagetool \
            https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Create AppDir
        run: |
          mkdir -p AppDir/usr/bin
          cp dist/IDMT-Trip-Calculator AppDir/usr/bin/
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp icon.png AppDir/usr/share/icons/hicolor/256x256/apps/idmt.png
          echo "[Desktop Entry]
Type=Application
Name=IDMT Trip Calculator
Exec=IDMT-Trip-Calculator
Icon=idmt
Categories=Utility;" > AppDir/IDMT.desktop
          echo "#!/bin/bash
DIR=\$(dirname \$(readlink -f \"\$0\"))
exec \"\$DIR/usr/bin/IDMT-Trip-Calculator\"" > AppDir/AppRun
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool AppDir IDMT-Trip-Calculator.AppImage

      - name: Test AppImage
        run: |
          chmod +x IDMT-Trip-Calculator.AppImage
          xvfb-run -a ./IDMT-Trip-Calculator.AppImage &
          sleep 3
          pgrep -f IDMT-Trip-Calculator || exit 1
          pkill IDMT-Trip-Calculator

      # --- Build DEB ---
      - name: Build DEB package
        run: |
          mkdir -p deb/DEBIAN
          echo "Package: idmt-trip-calculator
Version: ${GITHUB_REF_NAME#v}
Architecture: amd64
Maintainer: godwintgn
Description: IEC Relay IDMT Calculator" > deb/DEBIAN/control

          mkdir -p deb/usr/local/bin
          cp dist/IDMT-Trip-Calculator deb/usr/local/bin/idmt-trip-calculator

          mkdir -p deb/usr/share/icons/hicolor/256x256/apps
          cp icon.png deb/usr/share/icons/hicolor/256x256/apps/idmt.png

          dpkg-deb --build deb idmt-trip-calculator_${GITHUB_REF_NAME#v}_amd64.deb

      - name: Test DEB install
        run: |
          sudo apt install -y ./idmt-trip-calculator*.deb
          xvfb-run -a IDMT-Trip-Calculator &
          sleep 3
          pgrep -f IDMT-Trip-Calculator || exit 1
          sudo apt remove -y idmt-trip-calculator

      # --- Build RPM ---
      - name: Build RPM package
        run: |
          fpm -s dir -t rpm \
            -n idmt-trip-calculator \
            -v ${GITHUB_REF_NAME#v} \
            dist/IDMT-Trip-Calculator=/usr/local/bin/idmt-trip-calculator \
            icon.png=/usr/share/icons/hicolor/256x256/apps/idmt.png

      - name: Test RPM (Fedora Container)
        run: |
          docker run --rm -v "$PWD:/app" fedora:40 bash -c "
            dnf install -y /app/*.rpm &&
            xvfb-run -a IDMT-Trip-Calculator &
            sleep 3
            pgrep -f IDMT-Trip-Calculator || exit 1
            dnf remove -y idmt-trip-calculator
          "

      - name: Upload Linux builds
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            IDMT-Trip-Calculator.AppImage
            *.deb
            *.rpm


  # ---------------------------------------------------------
  #  PUBLISH RELEASE
  # ---------------------------------------------------------
  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
